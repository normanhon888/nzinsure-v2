name: Codex release gate

on:
  workflow_dispatch:

jobs:
  release_gate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5

      - name: Run Codex release-gate
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/release-gate.md
          safety-strategy: drop-sudo
          sandbox: read-only
          read-only: true
          codex-args: '["--output-schema",".github/codex/schemas/release-gate.schema.json"]'

      - name: Save report as JSON (validate JSON)
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.run_codex.outputs.final-message }}
        run: |
          python - <<'PY'
          import os, json
          s = (os.environ.get("CODEX_FINAL_MESSAGE") or "").strip()
          json.loads(s)
          open("codex-release-gate.json","w",encoding="utf-8").write(s)
          print("OK: codex-release-gate.json written and valid JSON")
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codex-release-gate
          path: codex-release-gate.json
